---
- name: Bootstrap OpenShift GitOps on Hub Cluster
  hosts: localhost
  gather_facts: false

  vars:
    gitops_namespace: openshift-gitops-operator
    manifests_dir: "{{ playbook_dir }}/../../manifests"

  pre_tasks:
    - name: Verify oc is logged in
      ansible.builtin.command:
        cmd: oc whoami
      register: oc_whoami
      changed_when: false
      failed_when: oc_whoami.rc != 0

    - name: Display logged in user
      ansible.builtin.debug:
        msg: "Logged in as: {{ oc_whoami.stdout }}"

  tasks:
    # =========================================================================
    # Install OpenShift GitOps Operator
    # =========================================================================
    - name: Apply OpenShift GitOps operator manifests
      ansible.builtin.command:
        cmd: oc apply -k {{ manifests_dir }}/operators/openshift-gitops
      register: apply_gitops
      changed_when: "'created' in apply_gitops.stdout or 'configured' in apply_gitops.stdout"

    # =========================================================================
    # Wait for Operator Installation
    # =========================================================================
    - name: Wait for OpenShift GitOps Operator to be installed
      ansible.builtin.command:
        cmd: >
          oc get csv -n {{ gitops_namespace }}
          -o jsonpath='{.items[?(@.spec.displayName=="Red Hat OpenShift GitOps")].status.phase}'
      register: csv_status
      until: csv_status.stdout == 'Succeeded'
      retries: 30
      delay: 10
      changed_when: false

    - name: Wait for openshift-gitops namespace to be created
      ansible.builtin.command:
        cmd: oc get namespace openshift-gitops
      register: gitops_ns
      until: gitops_ns.rc == 0
      retries: 30
      delay: 10
      changed_when: false

    # =========================================================================
    # Wait for ArgoCD Instance
    # =========================================================================
    - name: Wait for ArgoCD instance to be ready
      ansible.builtin.command:
        cmd: >
          oc get argocd openshift-gitops -n openshift-gitops
          -o jsonpath='{.status.phase}'
      register: argocd_status
      until: argocd_status.stdout == 'Available'
      retries: 30
      delay: 10
      changed_when: false

    - name: Wait for ArgoCD Server deployment to be ready
      ansible.builtin.command:
        cmd: >
          oc rollout status deployment/openshift-gitops-server
          -n openshift-gitops --timeout=300s
      register: argocd_server_rollout
      changed_when: false

    # =========================================================================
    # Create ArgoCD Application for Hub Operators
    # =========================================================================
    - name: Apply ArgoCD Application for hub operators
      ansible.builtin.command:
        cmd: oc apply -k {{ manifests_dir }}/argocd-apps
      register: apply_argocd_apps
      changed_when: "'created' in apply_argocd_apps.stdout or 'configured' in apply_argocd_apps.stdout"

    # =========================================================================
    # Get ArgoCD Access Information
    # =========================================================================
    - name: Get ArgoCD route
      ansible.builtin.command:
        cmd: oc get route openshift-gitops-server -n openshift-gitops -o jsonpath='{.spec.host}'
      register: argocd_route
      changed_when: false

    - name: Get ArgoCD admin password
      ansible.builtin.command:
        cmd: oc get secret openshift-gitops-cluster -n openshift-gitops -o jsonpath='{.data.admin\.password}'
      register: argocd_password_b64
      changed_when: false

    - name: Decode ArgoCD admin password
      ansible.builtin.set_fact:
        argocd_password: "{{ argocd_password_b64.stdout | b64decode }}"

    # =========================================================================
    # Summary
    # =========================================================================
    - name: Display OpenShift GitOps installation summary
      ansible.builtin.debug:
        msg:
          - "=============================================="
          - "OpenShift GitOps Bootstrapped Successfully"
          - "=============================================="
          - ""
          - "ArgoCD Console: https://{{ argocd_route.stdout }}"
          - ""
          - "Credentials:"
          - "  Username: admin"
          - "  Password: {{ argocd_password }}"
          - ""
          - "CLI Login:"
          - "  argocd login {{ argocd_route.stdout }} --username admin --password '{{ argocd_password }}' --insecure"
          - ""
          - "Operators being installed via GitOps:"
          - "  - OpenShift GitOps"
          - "  - OpenShift Pipelines"
          - "  - OpenShift Cert Manager"
          - "  - External Secrets Operator"
          - "  - Red Hat Developer Hub"
          - ""
          - "=============================================="
